!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("babylonjs")):"function"==typeof define&&define.amd?define("babylonjs-loaders",["babylonjs"],t):"object"==typeof exports?exports["babylonjs-loaders"]=t(require("babylonjs")):e.LOADERS=t(e.BABYLON)}("undefined"!=typeof self?self:"undefined"!=typeof global?global:this,(e=>(()=>{"use strict";var t={597:t=>{t.exports=e}},r={};function o(e){var n=r[e];if(void 0!==n)return n.exports;var i=r[e]={exports:{}};return t[e](i,i.exports,o),i.exports}o.d=(e,t)=>{for(var r in t)o.o(t,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};o.d(n,{default:()=>I});var i={};o.r(i),o.d(i,{BVHFileLoader:()=>x,ReadBvh:()=>b});var a={};o.r(a),o.d(a,{BVHFileLoader:()=>x,ReadBvh:()=>b});var s=o(597),f="Xposition",l="Yposition",p="Zposition",c="Xrotation",d="Yrotation",u="Zrotation",h="HIERARCHY",m="MOTION",v=function(e){this.loopMode=s.Animation.ANIMATIONLOOPMODE_CYCLE,this.list=[],this.root=y(),this.numFrames=0,this.frameRate=0,this.skeleton=e};function y(){return{name:"",type:"",offset:new s.Vector3,channels:[],children:[],frames:[],parent:null}}function w(e,t,r){for(var o=function(e){var t=e.offset.x,r=e.offset.y,o=e.offset.z;return s.Matrix.Translation(t,r,o)}(e),n=new s.Bone(e.name,r.skeleton,t,o),i=function(e,t){if(0===e.frames.length)return[];for(var r=[],o=e.channels.some((function(e){return e===f||e===l||e===p})),n=e.channels.some((function(e){return e===c||e===d||e===u})),i=new s.Animation("".concat(e.name,"_pos"),"position",t.frameRate,s.Animation.ANIMATIONTYPE_VECTOR3,t.loopMode),a=new s.Animation("".concat(e.name,"_rot"),"rotationQuaternion",t.frameRate,s.Animation.ANIMATIONTYPE_QUATERNION,t.loopMode),h=[],m=[],v=0;v<e.frames.length;v++){var y=e.frames[v];o&&y.position&&h.push({frame:y.frame,value:y.position.clone()}),n&&m.push({frame:y.frame,value:y.rotation.clone()})}return h.length>0&&(i.setKeys(h),r.push(i)),m.length>0&&(a.setKeys(m),r.push(a)),r}(e,r),a=0,h=i;a<h.length;a++){var m=h[a];m.getKeys()&&m.getKeys().length>0&&n.animations.push(m)}for(var v=0,y=e.children;v<y.length;v++)w(y[v],n,r)}function E(e,t,r,o){if("ENDSITE"!==r.type){var n={frame:0,position:new s.Vector3,rotation:new s.Quaternion};n.frame=t,n.position=new s.Vector3,n.rotation=new s.Quaternion,r.frames.push(n);for(var i=s.Matrix.Identity(),a=0;a<r.channels.length;++a){var h=r.channels[a],m=e[o.i++];if(m){var v=parseFloat(m.trim());if(h.endsWith("position"))switch(h){case f:n.position.x=v;break;case l:n.position.y=v;break;case p:n.position.z=v}else if(h.endsWith("rotation")){var y=s.Tools.ToRadians(v),w=void 0;switch(h){case c:w=s.Matrix.RotationX(y);break;case d:w=s.Matrix.RotationY(y);break;case u:w=s.Matrix.RotationZ(y)}i=w.multiply(i)}}}s.Quaternion.FromRotationMatrixToRef(i,n.rotation);for(var g=0,b=r.children;g<b.length;g++)E(e,t,b[g],o)}}function g(e,t,r,o){var n,i,a,f,l=y();l.parent=r,o.list.push(l);var p=t.trim().split(/\s+/);if("END"===p[0].toUpperCase()&&"SITE"===p[1].toUpperCase()?(l.type="ENDSITE",l.name="ENDSITE"):(l.name=p[1],l.type=p[0].toUpperCase()),"{"!=(null===(n=e.shift())||void 0===n?void 0:n.trim()))throw new Error("Expected opening { after type & name");var c=null===(i=e.shift())||void 0===i?void 0:i.trim().split(/\s+/);if(!c)throw new Error("Unexpected end of file: missing OFFSET");if("OFFSET"!=(p=c)[0].toUpperCase())throw new Error("Expected OFFSET, but got: "+p[0]);if(4!=p.length)throw new Error("OFFSET: Invalid number of values");var d=new s.Vector3(parseFloat(p[1]),parseFloat(p[2]),parseFloat(p[3]));if(isNaN(d.x)||isNaN(d.y)||isNaN(d.z))throw new Error("OFFSET: Invalid values");if(l.offset=d,"ENDSITE"!=l.type){if(!(p=null===(a=e.shift())||void 0===a?void 0:a.trim().split(/\s+/)))throw new Error("Unexpected end of file: missing CHANNELS");if("CHANNELS"!=p[0].toUpperCase())throw new Error("Expected CHANNELS definition");var u=parseInt(p[1]);l.channels=p.splice(2,u),l.children=[]}for(;e.length>0;){var h=null===(f=e.shift())||void 0===f?void 0:f.trim();if("}"===h)return l;h&&l.children.push(g(e,h,l,o))}throw new Error("Unexpected end of file: missing closing brace")}function b(e,t,r,o){var n=e.split("\n"),i=o.loopMode;t._blockEntityCollection=!!r;var a=new s.Skeleton("","",t);a._parentContainer=r,t._blockEntityCollection=!1;var f=new v(a);f.loopMode=i;var l=n.shift();if(!l||l.trim().toUpperCase()!==h)throw new Error("HIERARCHY expected");var p=n.shift();if(!p)throw new Error("Unexpected end of file after HIERARCHY");var c=g(n,p.trim(),null,f),d=n.shift();if(!d||d.trim().toUpperCase()!==m)throw new Error("MOTION expected");var u=n.shift();if(!u)throw new Error("Unexpected end of file before frame count");var y=u.trim().split(/[\s]+/);if(y.length<2)throw new Error("Invalid frame count line");var b=parseInt(y[1]);if(isNaN(b))throw new Error("Failed to read number of frames.");f.numFrames=b;var N=n.shift();if(!N)throw new Error("Unexpected end of file before frame time");var O=N.trim().split(/[\s]+/);if(O.length<3)throw new Error("Invalid frame time line");var x=parseFloat(O[2]);if(isNaN(x))throw new Error("Failed to read frame time.");if(x<=0)throw new Error("Failed to read frame time. Invalid value "+x);f.frameRate=1/x;for(var A=0;A<b;++A){var H=n.shift();H&&E(H.trim().split(/[\s]+/)||[],A,c,{i:0})}return f.root=c,w(f.root,null,f),f.skeleton.returnToRest(),f.skeleton}var N=function(){return N=Object.assign||function(e){for(var t,r=1,o=arguments.length;r<o;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},N.apply(this,arguments)};Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;var O={".bvh":{isBinary:!1}},x=function(){function e(t){this.name="bvh",this.extensions=O,this._loadingOptions=N(N({},e._DefaultLoadingOptions),null!=t?t:{})}return Object.defineProperty(e,"_DefaultLoadingOptions",{get:function(){return{loopMode:s.Animation.ANIMATIONLOOPMODE_CYCLE}},enumerable:!1,configurable:!0}),e.prototype.createPlugin=function(t){return new e(t.bvh)},e.prototype.canDirectLoad=function(e){return this.isBvhHeader(e)},e.prototype.isBvhHeader=function(e){return"HIERARCHY"==e.split("\n")[0]},e.prototype.isNotBvhHeader=function(e){return!this.isBvhHeader(e)},e.prototype.importMeshAsync=function(e,t,r){if("string"!=typeof r)return Promise.reject("BVH loader expects string data.");if(this.isNotBvhHeader(r))return Promise.reject("BVH loader expects HIERARCHY header.");try{var o=b(r,t,null,this._loadingOptions);return Promise.resolve({meshes:[],particleSystems:[],skeletons:[o],animationGroups:[],transformNodes:[],geometries:[],lights:[],spriteManagers:[]})}catch(e){return Promise.reject(e)}},e.prototype.loadAsync=function(e,t){return"string"!=typeof t?Promise.reject("BVH loader expects string data."):this.isNotBvhHeader(t)?Promise.reject("BVH loader expects HIERARCHY header."):this.importMeshAsync(null,e,t).then((function(){}))},e.prototype.loadAssetContainerAsync=function(e,t){if("string"!=typeof t)return Promise.reject("BVH loader expects string data.");if(this.isNotBvhHeader(t))return Promise.reject("BVH loader expects HIERARCHY header.");var r=new s.AssetContainer(e);try{var o=b(t,e,r,this._loadingOptions);return r.skeletons.push(o),Promise.resolve(r)}catch(e){return Promise.reject(e)}},e}();(0,s.RegisterSceneLoaderPlugin)(new x);var A=void 0!==o.g?o.g:"undefined"!=typeof window?window:void 0;if(void 0!==A)for(var H in i)A.BABYLON[H]||(A.BABYLON[H]=i[H]);const I=a;return n.default})()));
//# sourceMappingURL=babylon.bvhFileLoader.min.js.map